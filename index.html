<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema Local - Cadastro Avan√ßado (PDF por linha + Geral)</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --primary:#2b6ef6;
      --accent:#06b6d4;
      --danger:#ef4444;
      --muted:#6b7280;
      --bg:#f6f8fb;
      --card:#ffffff;
      --radius:12px;
      --shadow: 0 8px 30px rgba(15,23,42,0.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Arial,sans-serif;
      background:var(--bg);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:24px;
      display:flex;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:1100px;
    }

    /* top nav */
    .nav{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
    }
    .brand{font-weight:700;color:var(--primary);font-size:18px}
    .nav .actions{display:flex;gap:8px;align-items:center}
    .pill{
      padding:8px 12px;border-radius:999px;background:linear-gradient(90deg,var(--primary),var(--accent));color:white;border:none;cursor:pointer;font-weight:600;
      box-shadow: 0 6px 18px rgba(43,110,246,0.12);
    }
    .ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:8px 12px;border-radius:10px;cursor:pointer}

    /* layout */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
      margin-bottom:18px;
    }

    /* auth */
    .auth-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .auth-grid .col{padding:12px}
    .label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
    input[type="text"], input[type="email"], input[type="password"]{
      width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef9;background:#fbfdff;
    }
    .btn{
      display:inline-block;padding:10px 14px;border-radius:10px;border:none;background:var(--primary);color:white;font-weight:700;cursor:pointer;
    }
    .btn.warn{background:var(--danger)}
    .small{font-size:13px;color:var(--muted)}

    /* controls row */
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .controls .input{flex:1;min-width:180px}
    .controls button{min-width:140px}

    /* search */
    .search{display:flex;gap:8px;align-items:center;margin-top:12px}
    .search input{flex:1;padding:10px;border-radius:10px;border:1px solid #e6eef9;background:#fff}

    /* table */
    table{width:100%;border-collapse:collapse;margin-top:12px}
    thead th{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;padding:12px;text-align:left;font-weight:700}
    th,td{padding:12px;border-bottom:1px solid #f1f5f9}
    td input{width:100%;padding:8px;border-radius:8px;border:1px solid #eef2ff;background:transparent}
    .row-actions{display:flex;gap:6px;align-items:center}
    .action-btn{padding:8px 10px;border-radius:8px;border:none;color:white;cursor:pointer;font-weight:700}
    .action-btn.pdf{background:linear-gradient(90deg,#7c3aed,#c026d3)}
    .action-btn.del{background:var(--danger)}
    .action-btn.save{background:#16a34a}

    /* mobile cards */
    @media(max-width:800px){
      .auth-grid{grid-template-columns:1fr; }
      table, thead, tbody, th, td, tr { display:block; width:100%;}
      thead{display:none}
      tr{background:var(--card);border-radius:10px;margin-bottom:12px;padding:12px;box-shadow:var(--shadow)}
      td{display:flex;justify-content:space-between;align-items:center;border:none;padding:8px 6px}
      td .left{flex:1}
      td .label-mobile{font-weight:700;color:var(--muted);margin-right:8px}
      td:not(:last-child){border-bottom:1px solid #f3f5f9}
      .controls{flex-direction:column}
      .controls .input{width:100%}
    }

    /* footer small */
    .meta{font-size:13px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="app">

    <!-- NAV -->
    <div class="nav">
      <div class="brand">Sistema Local ‚Äî Cadastros</div>
      <div class="actions">
        <button id="btnNew" class="ghost" onclick="mostrarRegister()">Registrar</button>
        <button id="btnLogin" class="ghost" onclick="mostrarLogin()">Login</button>
      </div>
    </div>

    <!-- AUTH CARD -->
    <div id="authCard" class="card">
      <div id="authInner">
        <!-- by default show register & login compact -->
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <div style="flex:1;min-width:260px">
            <div class="label">Nome</div>
            <input id="regNome" type="text" placeholder="Seu nome completo">
            <div class="label" style="margin-top:8px">Email</div>
            <input id="regEmail" type="email" placeholder="seu@exemplo.com">
            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn" onclick="registrar()">Criar Conta</button>
              <button class="ghost" onclick="mostrarLogin()">J√° tenho conta</button>
            </div>
          </div>
          <div style="flex:1;min-width:260px">
            <div class="label">Login</div>
            <input id="logEmail" type="email" placeholder="Email">
            <div class="label" style="margin-top:8px">Senha</div>
            <input id="logSenha" type="password" placeholder="Senha">
            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn" onclick="entrar()">Entrar</button>
              <button class="ghost" onclick="mostrarRegister()">Registrar</button>
            </div>
          </div>
        </div>
        <div class="meta">Os dados ficam no seu navegador (localStorage). Para testes use v√°rios e-mails diferentes.</div>
      </div>
    </div>

    <!-- MAIN APP CARD -->
    <div id="appCard" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:800;font-size:18px">Cadastro Local Avan√ßado</div>
          <div class="small" id="userBadge">‚Äî</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="ghost" onclick="apagarConta()">Apagar conta</button>
          <button class="pill" onclick="sair()">Sair</button>
        </div>
      </div>

      <!-- inputs + actions -->
      <div class="controls" style="margin-top:16px">
        <input id="cNome" class="input" placeholder="Nome">
        <input id="cSobrenome" class="input" placeholder="Sobrenome">
        <input id="cEmail" class="input" placeholder="Email">
        <button class="pill" onclick="adicionarRegistro()">üíæ Salvar</button>
        <button class="ghost" onclick="apagarTudo()">üóëÔ∏è Apagar todos</button>
      </div>

      <div class="search" style="margin-top:14px">
        <input id="searchInput" placeholder="üîç Buscar por UUID, nome, sobrenome, email" oninput="mostrar()">
        <div style="display:flex;gap:8px">
          <button class="ghost" onclick="mostrar(true)">Limpar</button>
          <button class="ghost" onclick="mostrar(true); document.getElementById('searchInput').value='';">Atualizar</button>
        </div>
      </div>

      <!-- table -->
      <div style="overflow:auto;margin-top:14px">
        <table id="tabela">
          <thead>
            <tr>
              <th>UUID</th>
              <th>Nome</th>
              <th>Sobrenome</th>
              <th>Email</th>
              <th style="width:210px">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- export -->
      <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;align-items:center">
        <button class="btn-txt ghost" onclick="exportarTXT()">Exportar TXT</button>
        <button class="btn-excel ghost" onclick="exportarCSV()">Exportar Excel (CSV)</button>
        <button class="btn-pdf ghost" onclick="exportarPDFGeral()">Exportar PDF Geral</button>
      </div>

      <div class="meta">Cada linha tem bot√£o PDF individual ‚Äî gera PDF somente daquele registro.</div>
    </div>
  </div>

  <script>
    /* ====== Helpers ====== */
    const pdfLogoBase64 = ''; // coloque base64 se quiser logo no cabe√ßalho do PDF
    function safeKey(email){ return 'cadastros_' + encodeURIComponent(email.toLowerCase()); }
    function gerarUUID(){
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
        const r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8);
        return v.toString(16);
      });
    }
    function nowReadable(){ return new Date().toLocaleString(); }

    /* ====== AUTH / SESS√ÉO ====== */
    function registrar(){
      const nome = document.getElementById('regNome').value.trim();
      const email = document.getElementById('regEmail').value.trim().toLowerCase();
      if(!email || !nome) return alert('Preencha nome e email para registrar.');
      let users = JSON.parse(localStorage.getItem('usuarios'))||[];
      if(users.find(u=>u.email===email)) return alert('E-mail j√° registrado.');
      // senha opcional aqui ‚Äî para simplicidade n√£o exigimos senha no registro compacto
      users.push({ nome, email, senha: '' });
      localStorage.setItem('usuarios', JSON.stringify(users));
      alert('Conta criada. Fa√ßa login.');
    }

    function mostrarLogin(){ document.getElementById('authCard').style.display='block'; }
    function mostrarRegister(){ document.getElementById('authCard').style.display='block'; }

    function entrar(){
      const e = document.getElementById('logEmail').value.trim().toLowerCase();
      const s = document.getElementById('logSenha').value;
      const users = JSON.parse(localStorage.getItem('usuarios'))||[];
      const user = users.find(u=>u.email===e);
      if(!user) return alert('Usu√°rio n√£o encontrado. Registre primeiro.');
      // aceitaremos qualquer senha (ou you can check) ‚Äî simple local auth
      localStorage.setItem('usuarioLogado', JSON.stringify(user));
      iniciarSessao();
    }

    function iniciarSessao(){
      const u = JSON.parse(localStorage.getItem('usuarioLogado'));
      if(!u) return;
      document.getElementById('authCard').style.display='none';
      document.getElementById('appCard').style.display='block';
      document.getElementById('userBadge').textContent = u.nome + ' ‚Äî ' + u.email;
      mostrar();
    }

    function sair(){
      localStorage.removeItem('usuarioLogado');
      document.getElementById('appCard').style.display='none';
      document.getElementById('authCard').style.display='block';
    }

    function apagarConta(){
      if(!confirm('Apagar conta e todos os cadastros? Esta a√ß√£o √© irrevers√≠vel.')) return;
      const u = JSON.parse(localStorage.getItem('usuarioLogado'));
      if(!u) return;
      // remove user from global (optional)
      let users = JSON.parse(localStorage.getItem('usuarios'))||[];
      users = users.filter(x=>x.email !== u.email);
      localStorage.setItem('usuarios', JSON.stringify(users));
      // remove cadastros
      localStorage.removeItem(safeKey(u.email));
      sair();
      alert('Conta removida.');
    }

    /* ====== CRUD Cadastros ====== */
    function carregarLista(){
      const u = JSON.parse(localStorage.getItem('usuarioLogado')); if(!u) return [];
      return JSON.parse(localStorage.getItem(safeKey(u.email))) || [];
    }
    function salvarLista(lista){
      const u = JSON.parse(localStorage.getItem('usuarioLogado')); if(!u) return;
      localStorage.setItem(safeKey(u.email), JSON.stringify(lista));
    }

    function adicionarRegistro(){
      const n = document.getElementById('cNome').value.trim();
      const s = document.getElementById('cSobrenome').value.trim();
      const e = document.getElementById('cEmail').value.trim();
      if(!n || !s || !e) return alert('Preencha todos os campos.');
      const lista = carregarLista();
      lista.push({ uuid: gerarUUID(), nome: n, sobrenome: s, email: e, criadoEm:new Date().toISOString() });
      salvarLista(lista);
      document.getElementById('cNome').value = document.getElementById('cSobrenome').value = document.getElementById('cEmail').value = '';
      mostrar();
    }

    function mostrar(forceClear=false){
      if(forceClear) document.getElementById('searchInput').value = '';
      const tbody = document.querySelector('#tabela tbody'); tbody.innerHTML = '';
      const lista = carregarLista();
      const q = (document.getElementById('searchInput').value||'').toLowerCase().trim();
      const filtrada = lista.filter(item=>{
        if(!q) return true;
        return [item.uuid,item.nome,item.sobrenome,item.email,item.criadoEm||''].join(' ').toLowerCase().includes(q);
      });

      filtrada.forEach(item=>{
        const tr = document.createElement('tr');
        // fallback labels for mobile via data-label handled in CSS
        tr.innerHTML = `
          <td>${item.uuid}</td>
          <td><input value="${escapeHtml(item.nome)}" onchange="atualizarCampo('${item.uuid}','nome',this.value)"></td>
          <td><input value="${escapeHtml(item.sobrenome)}" onchange="atualizarCampo('${item.uuid}','sobrenome',this.value)"></td>
          <td><input value="${escapeHtml(item.email)}" onchange="atualizarCampo('${item.uuid}','email',this.value)"></td>
          <td>
            <div class="row-actions">
              <button class="action-btn save" onclick="atualizarRegistro('${item.uuid}')">Salvar</button>
              <button class="action-btn del" onclick="apagar('${item.uuid}')">Apagar</button>
              <button class="action-btn pdf" onclick="exportarPDFIndividual('${item.uuid}')">PDF</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s){ return String(s).replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

    function atualizarCampo(uuid,campo,valor){
      const lista = carregarLista();
      const it = lista.find(x=>x.uuid===uuid);
      if(!it) return;
      it[campo] = valor.trim();
      salvarLista(lista);
    }
    function atualizarRegistro(uuid){ alert('Registro salvo!') }

    function apagar(uuid){
      if(!confirm('Apagar este registro?')) return;
      let lista = cargarLista();
      lista = lista.filter(x=>x.uuid!==uuid);
      salvarLista(lista);
      mostrar();
    }
    function apagarTudo(){
      if(!confirm('Apagar todos os registros?')) return;
      const u = JSON.parse(localStorage.getItem('usuarioLogado')); if(!u) return;
      localStorage.setItem(safeKey(u.email), JSON.stringify([]));
      mostrar();
    }

    /* ====== Export TXT / CSV ====== */
    function exportarTXT(){
      const lista = carregarLista();
      if(!lista.length) return alert('Sem dados!');
      let s = 'UUID\tNome\tSobrenome\tEmail\tCriadoEm\n';
      lista.forEach(x=> s += `${x.uuid}\t${x.nome}\t${x.sobrenome}\t${x.email}\t${x.criadoEm||''}\n`);
      const blob = new Blob([s],{type:'text/plain'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='cadastros.txt'; a.click(); URL.revokeObjectURL(a.href);
    }
    function exportarCSV(){
      const lista = carregarLista();
      if(!lista.length) return alert('Sem dados!');
      let csv = 'UUID,Nome,Sobrenome,Email,CriadoEm\n';
      lista.forEach(x=> csv += `"${x.uuid}","${x.nome}","${x.sobrenome}","${x.email}","${x.criadoEm||''}"\n`);
      const blob = new Blob([csv],{type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='cadastros.csv'; a.click(); URL.revokeObjectURL(a.href);
    }

    /* ====== PDF (individual & geral) using jsPDF ====== */
    function findItem(uuid){
      const lista = carregarLista(); return lista.find(x=>x.uuid===uuid);
    }

    function exportarPDFIndividual(uuid){
      const item = findItem(uuid);
      if(!item) return alert('Registro n√£o encontrado.');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      // header
      if(pdfLogoBase64){ try{ doc.addImage(pdfLogoBase64,'PNG',40,24,80,30); }catch(e){} }
      doc.setFontSize(16); doc.text('Relat√≥rio - Registro Individual', 140, 50);
      doc.setFontSize(10); doc.text('Gerado em: ' + nowReadable(), 40, 72);
      // body
      let y = 110;
      doc.setFontSize(12);
      doc.text('UUID: ' + item.uuid, 40, y); y += 18;
      doc.text('Nome: ' + item.nome, 40, y); y += 18;
      doc.text('Sobrenome: ' + item.sobrenome, 40, y); y += 18;
      doc.text('Email: ' + item.email, 40, y); y += 18;
      if(item.criadoEm) { doc.text('Criado em: ' + new Date(item.criadoEm).toLocaleString(), 40, y); y += 18; }
      // save
      const filename = (item.nome || 'registro').replace(/[^a-z0-9_\-]/gi,'_') + '.pdf';
      doc.save(filename);
    }

    function exportarPDFGeral(){
      const lista = carregarLista();
      if(!lista.length) return alert('Sem dados!');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      // header
      if(pdfLogoBase64){ try{ doc.addImage(pdfLogoBase64,'PNG',40,24,80,30); }catch(e){} }
      doc.setFontSize(16); doc.text('Relat√≥rio Geral de Cadastros', 40, 50);
      doc.setFontSize(10); doc.text('Gerado em: ' + nowReadable(), 40, 72);

      let y = 110;
      doc.setFontSize(11);
      lista.forEach((u, idx)=>{
        doc.text(`${idx+1}. UUID: ${u.uuid}`, 40, y); y+=14;
        doc.text(`   Nome: ${u.nome}`, 40, y); y+=14;
        doc.text(`   Sobrenome: ${u.sobrenome}`, 40, y); y+=14;
        doc.text(`   Email: ${u.email}`, 40, y); y+=16;
        if(u.criadoEm){ doc.text(`   Criado em: ${new Date(u.criadoEm).toLocaleString()}`, 40, y); y+=16; }
        y+=8;
        if(y > 750){ doc.addPage(); y = 60; }
      });
      doc.save('cadastros_geral.pdf');
    }

    /* ====== Init / Boot ====== */
    // Wire global functions to buttons/console if needed
    window.registrar = registrar;
    window.entrar = entrar;
    window.iniciarSessao = iniciarSessao;
    window.sair = sair;
    window.apagarConta = apagarConta;
    window.adicionarRegistro = adicionarRegistro;
    window.mostrar = mostrar;
    window.apagar = apagar;
    window.apagarTudo = apagarTudo;
    window.exportarTXT = exportarTXT;
    window.exportarCSV = exportarCSV;
    window.exportarPDFIndividual = exportarPDFIndividual;
    window.exportarPDFGeral = exportarPDFGeral;
    window.atualizarRegistro = atualizarRegistro;

    // If already logged
    if(localStorage.getItem('usuarioLogado')){
      iniciarSessao();
    }

    /* small utility: show empty table initially */
    mostrar();
  </script>
</body>
</html>