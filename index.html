<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema Local - Renovado (Login + Cadastro + PDF + Busca)</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ---------- Geral ---------- */
    body{font-family:Arial,system-ui; margin:0; background:#f6f7fb; color:#222}
    h2{text-align:center;margin:14px 0}
    .container{max-width:980px;margin:24px auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    input, select, textarea{padding:8px;border:1px solid #ccd; border-radius:6px;box-sizing:border-box}
    button{background:#2E8B57;color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
    button.gray{background:#777} button.warn{background:#d9534f} button.blue{background:#2196F3} button.purple{background:#8e44ad}
    .topbar{display:flex;justify-content:space-between;align-items:center;background:#2E8B57;color:#fff;padding:10px 16px;border-radius:8px}
    .topbar button{background:#d9534f;padding:8px 10px;border-radius:6px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .col{flex:1;min-width:160px}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border:1px solid #e8e8e8;text-align:left}
    th{background:#2E8B57;color:#fff}
    td input{width:95%;padding:6px;border:1px solid #ddd;border-radius:6px}

    /* mobile: transforma linhas em cards */
    @media (max-width:760px){
      table,thead,tbody,th,td,tr{display:block;width:100%}
      thead{display:none}
      tr{background:#fff;margin-bottom:12px;padding:10px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
      td{display:flex;justify-content:space-between;align-items:center;border:none;border-bottom:1px solid #f0f0f0;padding:8px 6px}
      td::before{content:attr(data-label);font-weight:700;color:#444;flex:0 0 42%;margin-right:8px}
      td:last-child{border-bottom:none;display:flex;gap:8px;justify-content:flex-end}
      td input{width:60%;min-width:120px}
      .row{flex-direction:column}
      .container{margin:10px}
    }

    .msg{font-weight:600;color:#b00;margin-top:6px}
    .searchBox{display:flex;gap:8px;align-items:center}
    .searchBox input{flex:1}
    .small{font-size:0.9rem;padding:6px 8px}
  </style>
</head>
<body>

  <!-- LOGIN / REGISTRO -->
  <div class="container" id="authContainer">
    <h2 id="authTitle">Registrar</h2>

    <div id="registerView">
      <div class="row">
        <input id="regNome" placeholder="Nome completo" class="col">
        <input id="regEmail" placeholder="E-mail" class="col" type="email">
      </div>
      <div class="row">
        <input id="regSenha" placeholder="Senha (m√≠n. 4)" type="password" class="col">
        <input id="regSenhaConf" placeholder="Confirmar senha" type="password" class="col">
      </div>
      <div class="row">
        <button onclick="registrar()">Criar conta</button>
        <button class="gray" onclick="mostrarLogin()">J√° tenho conta</button>
      </div>
      <p id="regMsg" class="msg"></p>
    </div>

    <div id="loginView" class="hidden">
      <div class="row">
        <input id="logEmail" placeholder="E-mail" class="col" type="email">
        <input id="logSenha" placeholder="Senha" class="col" type="password">
      </div>
      <div class="row">
        <button onclick="entrar()">Entrar</button>
        <button class="gray" onclick="mostrarRegister()">Ainda n√£o tenho conta</button>
      </div>
      <p id="logMsg" class="msg"></p>
    </div>
  </div>

  <!-- √ÅREA PRINCIPAL -->
  <div class="container hidden" id="mainContainer">
    <div class="topbar">
      <div><strong>Cadastro Local Avan√ßado</strong></div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="userBadge"></div>
        <button onclick="sair()">Sair</button>
      </div>
    </div>

    <!-- controles: formul√°rio + a√ß√µes + busca -->
    <div style="margin-top:12px">
      <div class="row">
        <input id="cNome" placeholder="Nome">
        <input id="cSobrenome" placeholder="Sobrenome">
        <input id="cEmail" placeholder="Email">
      </div>

      <div class="row">
        <button onclick="adicionarRegistro()">üíæ Salvar</button>
        <button class="warn" onclick="apagarTudo()">üóëÔ∏è Apagar todos</button>
        <button class="blue" onclick="exportarTXT()">üìÑ Exportar TXT</button>
        <button onclick="exportarExcel()">üìä Exportar Excel</button>
        <button class="purple" onclick="exportarPDFGeral()">üìò Exportar Todos PDF</button>
      </div>

      <div class="row" style="margin-top:8px;align-items:center">
        <div class="searchBox col">
          <input id="searchInput" placeholder="Buscar (UUID, Nome, Sobrenome, Email)" oninput="mostrar()">
        </div>
        <div style="min-width:160px;display:flex;gap:8px">
          <button class="gray small" onclick="mostrar(true)">Limpar / Atualizar</button>
          <button class="gray small" onclick="apagarConta()">Apagar conta</button>
        </div>
      </div>
    </div>

    <!-- tabela -->
    <div style="margin-top:12px; overflow:auto">
      <table id="tabela">
        <thead>
          <tr>
            <th>UUID</th><th>Nome</th><th>Sobrenome</th><th>Email</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
/* ============================
   CONFIGUR√ÅVEIS
   - pdfLogoBase64: cole aqui seu logo em base64 se quiser
   ============================ */
const pdfLogoBase64 = ''; // ex: "data:image/png;base64,iVBORw0K..." (deixe vazio para sem logo)

/* ============================
   UTIL / AUTENTICA√á√ÉO
   ============================ */
function safeEmailKey(email){ return 'cadastros_' + encodeURIComponent(email.toLowerCase()); }

function gerarUUID(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
    const r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8);
    return v.toString(16);
  });
}

/* Mostrar/ocultar views */
const authContainer = document.getElementById('authContainer');
const mainContainer = document.getElementById('mainContainer');

function mostrarLogin(){
  document.getElementById('authTitle').innerText = 'Login';
  document.getElementById('registerView').classList.add('hidden');
  document.getElementById('loginView').classList.remove('hidden');
  clearMsgs();
}
function mostrarRegister(){
  document.getElementById('authTitle').innerText = 'Registrar';
  document.getElementById('registerView').classList.remove('hidden');
  document.getElementById('loginView').classList.add('hidden');
  clearMsgs();
}
function clearMsgs(){ document.getElementById('regMsg').textContent=''; document.getElementById('logMsg').textContent=''; }

/* Registro */
function registrar(){
  const nome = document.getElementById('regNome').value.trim();
  const email = document.getElementById('regEmail').value.trim().toLowerCase();
  const senha = document.getElementById('regSenha').value;
  const conf = document.getElementById('regSenhaConf').value;
  const msg = document.getElementById('regMsg');

  if(!nome||!email||!senha||!conf){ msg.style.color='red'; msg.textContent='Preencha todos os campos!'; return; }
  if(senha.length<4){ msg.style.color='red'; msg.textContent='Senha muito curta (m√≠n.4).'; return; }
  if(senha!==conf){ msg.style.color='red'; msg.textContent='Senhas n√£o coincidem.'; return; }

  const users = JSON.parse(localStorage.getItem('usuarios'))||[];
  if(users.find(u=>u.email===email)){ msg.style.color='red'; msg.textContent='E-mail j√° cadastrado.'; return; }

  users.push({ nome, email, senha });
  localStorage.setItem('usuarios', JSON.stringify(users));
  msg.style.color='green'; msg.textContent='Conta criada! Fa√ßa login.';
  setTimeout(()=>{ mostrarLogin(); }, 700);
}

/* Login */
function entrar(){
  const email = document.getElementById('logEmail').value.trim().toLowerCase();
  const senha = document.getElementById('logSenha').value;
  const msg = document.getElementById('logMsg');
  if(!email||!senha){ msg.style.color='red'; msg.textContent='Preencha e-mail e senha!'; return; }

  const users = JSON.parse(localStorage.getItem('usuarios'))||[];
  const user = users.find(u => u.email===email && u.senha===senha);
  if(!user){ msg.style.color='red'; msg.textContent='Credenciais inv√°lidas.'; return; }
  localStorage.setItem('usuarioLogado', JSON.stringify(user));
  iniciarSessao();
}

/* Sair */
function sair(){
  localStorage.removeItem('usuarioLogado');
  mainContainer.classList.add('hidden');
  authContainer.classList.remove('hidden');
  mostrarLogin();
}

/* iniciar se j√° logado */
function iniciarSessao(){
  const user = JSON.parse(localStorage.getItem('usuarioLogado'));
  if(!user) return;
  document.getElementById('userBadge').textContent = user.nome + ' ('+user.email+')';
  authContainer.classList.add('hidden');
  mainContainer.classList.remove('hidden');
  mostrar();
}

/* ============================
   CRUD de cadastros (por usu√°rio)
   ============================ */

function carregarLista(){
  const user = JSON.parse(localStorage.getItem('usuarioLogado'));
  if(!user) return [];
  const key = safeEmailKey(user.email);
  return JSON.parse(localStorage.getItem(key)) || [];
}

function salvarLista(lista){
  const user = JSON.parse(localStorage.getItem('usuarioLogado'));
  if(!user) return;
  localStorage.setItem(safeEmailKey(user.email), JSON.stringify(lista));
}

/* Adicionar registro */
function adicionarRegistro(){
  const n = document.getElementById('cNome').value.trim();
  const s = document.getElementById('cSobrenome').value.trim();
  const e = document.getElementById('cEmail').value.trim();
  if(!n||!s||!e){ alert('Preencha todos os campos!'); return; }

  const lista = carregarLista();
  lista.push({ uuid: gerarUUID(), nome: n, sobrenome: s, email: e, criadoEm: new Date().toISOString() });
  salvarLista(lista);
  document.getElementById('cNome').value = document.getElementById('cSobrenome').value = document.getElementById('cEmail').value = '';
  mostrar();
}

/* Mostrar tabela (com busca) */
function mostrar(forceClear=false){
  if(forceClear){
    document.getElementById('searchInput').value = '';
  }
  const tbody = document.querySelector('#tabela tbody');
  tbody.innerHTML = '';
  const lista = carregarLista();
  const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();

  const filtrada = lista.filter(item => {
    if(!q) return true;
    return [item.uuid, item.nome, item.sobrenome, item.email, item.criadoEm || '']
      .join(' ').toLowerCase().includes(q);
  });

  filtrada.forEach(item => {
    const tr = document.createElement('tr');

    const tdUUID = document.createElement('td'); tdUUID.textContent = item.uuid; tdUUID.setAttribute('data-label','UUID'); tr.appendChild(tdUUID);

    const tdNome = document.createElement('td'); tdNome.setAttribute('data-label','Nome');
    const inNome = document.createElement('input'); inNome.value = item.nome;
    inNome.onchange = ()=> atualizarCampo(item.uuid,'nome', inNome.value); tdNome.appendChild(inNome); tr.appendChild(tdNome);

    const tdSob = document.createElement('td'); tdSob.setAttribute('data-label','Sobrenome');
    const inSob = document.createElement('input'); inSob.value = item.sobrenome;
    inSob.onchange = ()=> atualizarCampo(item.uuid,'sobrenome', inSob.value); tdSob.appendChild(inSob); tr.appendChild(tdSob);

    const tdEmail = document.createElement('td'); tdEmail.setAttribute('data-label','Email');
    const inEmail = document.createElement('input'); inEmail.value = item.email;
    inEmail.onchange = ()=> atualizarCampo(item.uuid,'email', inEmail.value); tdEmail.appendChild(inEmail); tr.appendChild(tdEmail);

    const tdA = document.createElement('td'); tdA.setAttribute('data-label','A√ß√µes');
    const btnAlt = document.createElement('button'); btnAlt.textContent='Salvar'; btnAlt.onclick = ()=> atualizarRegistro(item.uuid);
    const btnDel = document.createElement('button'); btnDel.textContent='Apagar'; btnDel.className='warn'; btnDel.onclick = ()=> apagar(item.uuid);
    const btnPdf = document.createElement('button'); btnPdf.textContent='PDF'; btnPdf.className='purple'; btnPdf.onclick = ()=> exportarPDFIndividual(item);
    tdA.append(btnAlt, btnDel, btnPdf);
    tr.appendChild(tdA);

    tbody.appendChild(tr);
  });
}

/* Atualizar campo e salvar imediatamente */
function atualizarCampo(uuid,campo,valor){
  const lista = carregarLista();
  const item = lista.find(x=>x.uuid===uuid);
  if(!item) return;
  item[campo] = valor;
  salvarLista(lista);
}

/* Salvar registro (bot√£o Salvar da linha) */
function atualizarRegistro(uuid){
  alert('Registro atualizado!');
}

/* Apagar */
function apagar(uuid){
  if(!confirm('Apagar este registro?')) return;
  let lista = carregarLista();
  lista = lista.filter(x=>x.uuid!==uuid);
  salvarLista(lista);
  mostrar();
}

/* Apagar tudo */
function apagarTudo(){
  if(!confirm('Apagar todos os registros?')) return;
  const user = JSON.parse(localStorage.getItem('usuarioLogado'));
  if(!user) return;
  localStorage.setItem(safeEmailKey(user.email), JSON.stringify([]));
  mostrar();
}

/* Apagar conta (remove usu√°rio e todos os cadastros) */
function apagarConta(){
  if(!confirm('Apagar sua conta e todos os cadastros? Esta a√ß√£o √© irrevers√≠vel.')) return;
  const user = JSON.parse(localStorage.getItem('usuarioLogado'));
  if(!user) return;
  // remover usu√°rio da lista global
  let users = JSON.parse(localStorage.getItem('usuarios')) || [];
  users = users.filter(u => u.email !== user.email);
  localStorage.setItem('usuarios', JSON.stringify(users));
  // remover cadastros do usu√°rio
  localStorage.removeItem(safeEmailKey(user.email));
  // logout
  sair();
  alert('Conta e cadastros removidos.');
}

/* Gerar TXT / CSV */
function gerarTXT(lista){
  let s = 'UUID\tNome\tSobrenome\tEmail\tCriadoEm\n';
  lista.forEach(x => s += `${x.uuid}\t${x.nome}\t${x.sobrenome}\t${x.email}\t${x.criadoEm || ''}\n`);
  return s;
}
function exportarTXT(){
  const lista = carregarLista();
  if(lista.length===0) return alert('Sem dados!');
  const blob = new Blob([gerarTXT(lista)],{type:'text/plain'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'cadastros.txt'; a.click();
  URL.revokeObjectURL(a.href);
}
function exportarExcel(){
  const lista = carregarLista();
  if(lista.length===0) return alert('Sem dados!');
  let csv = 'UUID,Nome,Sobrenome,Email,CriadoEm\n';
  lista.forEach(x => csv += `"${x.uuid}","${x.nome}","${x.sobrenome}","${x.email}","${x.criadoEm || ''}"\n`);
  const blob = new Blob([csv],{type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'cadastros.csv'; a.click();
  URL.revokeObjectURL(a.href);
}

/* ============================
   PDF (individual e geral) - com cabe√ßalho, data e logo opcional
   ============================ */

function formatDateISOToReadable(iso){
  try{ const d = new Date(iso); return d.toLocaleString(); }catch{ return iso; }
}

function exportarPDFIndividual(item){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});

  // Cabe√ßalho (logo opcional)
  if(pdfLogoBase64){
    try{ doc.addImage(pdfLogoBase64, 'PNG', 40, 20, 80, 30); }catch(e){ console.warn('Erro ao inserir logo:', e); }
  }
  doc.setFontSize(16);
  doc.text('Relat√≥rio - Registro Individual', 140, 40);
  doc.setFontSize(10);
  doc.text('Gerado em: ' + new Date().toLocaleString(), 40, 70);

  let y = 110;
  doc.setFontSize(12);
  doc.text('UUID: ' + item.uuid, 40, y); y += 18;
  doc.text('Nome: ' + item.nome, 40, y); y += 18;
  doc.text('Sobrenome: ' + item.sobrenome, 40, y); y += 18;
  doc.text('Email: ' + item.email, 40, y); y += 18;
  if(item.criadoEm) { doc.text('Criado em: ' + formatDateISOToReadable(item.criadoEm), 40, y); y+=18; }

  const filename = (item.nome || 'registro') .replace(/[^a-z0-9_\-]/gi,'_') + '.pdf';
  doc.save(filename);
}

function exportarPDFGeral(){
  const lista = carregarLista();
  if(lista.length===0) return alert('Sem dados!');

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});

  if(pdfLogoBase64){
    try{ doc.addImage(pdfLogoBase64, 'PNG', 40, 20, 80, 30); }catch(e){ console.warn('Erro ao inserir logo:', e); }
  }
  doc.setFontSize(16);
  doc.text('Relat√≥rio Geral de Cadastros', 140, 40);
  doc.setFontSize(10);
  doc.text('Gerado em: ' + new Date().toLocaleString(), 40, 70);

  let y = 110;
  doc.setFontSize(11);
  lista.forEach((u, idx) => {
    doc.text(`${idx+1}. UUID: ${u.uuid}`, 40, y); y += 14;
    doc.text(`   Nome: ${u.nome}`, 40, y); y += 14;
    doc.text(`   Sobrenome: ${u.sobrenome}`, 40, y); y += 14;
    doc.text(`   Email: ${u.email}`, 40, y); y += 18;
    if(u.criadoEm){ doc.text(`   Criado em: ${formatDateISOToReadable(u.criadoEm)}`, 40, y); y += 18; }
    y += 6;
    if(y > 740){ doc.addPage(); y = 60; }
  });

  doc.save('cadastros_geral.pdf');
}

/* ============================
   Inicializa√ß√£o: checar login
   ============================ */

window.addEventListener('load', ()=>{
  const log = localStorage.getItem('usuarioLogado');
  if(log){ iniciarSessao(); }
  else { mostrarRegister(); }
});

/* Tornar fun√ß√µes acess√≠veis globalmente (bot√µes inline) */
window.registrar = registrar;
window.entrar = entrar;
window.mostrarLogin = mostrarLogin;
window.mostrarRegister = mostrarRegister;
window.sair = sair;
window.adicionarRegistro = adicionarRegistro;
window.mostrar = mostrar;
window.apagar = apagar;
window.apagarTudo = apagarTudo;
window.exportarTXT = exportarTXT;
window.exportarExcel = exportarExcel;
window.exportarPDFIndividual = exportarPDFIndividual;
window.exportarPDFGeral = exportarPDFGeral;
window.apagarConta = apagarConta;
</script>
</body>
</html>